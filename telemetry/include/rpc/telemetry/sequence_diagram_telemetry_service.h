/*
 *   Copyright (c) 2026 Edward Boggis-Rolfe
 *   All rights reserved.
 */
#pragma once

#include <unordered_map>
#include <string>
#include <mutex>
#include <fstream>
#include <filesystem>

// types.h is included via i_telemetry_service.h
#include <rpc/telemetry/i_telemetry_service.h>

namespace rpc
{
    class sequence_diagram_telemetry_service : public rpc::i_telemetry_service
    {
        struct name_count
        {
            std::string name;
            int count = 0;
        };

        struct zone_object
        {
            rpc::zone zone_id = {0};
            rpc::object object_id = {0};

            bool operator==(const zone_object& other) const
            {
                return zone_id == other.zone_id && object_id == other.object_id;
            }
        };

        struct zone_object_hash
        {
            std::size_t operator()(zone_object const& s) const noexcept
            {
                std::size_t h1 = std::hash<uint64_t>{}(s.zone_id.get_val());
                std::size_t h2 = std::hash<uint64_t>{}(s.object_id.get_val());
                return h1 ^ (h2 << 1); // or use boost::hash_combine
            }
        };

        struct orig_zone
        {
            rpc::zone zone_id = {0};
            rpc::destination_zone destination_zone_id = {0};
            rpc::caller_zone caller_zone_id = {0};
            bool operator==(const orig_zone& other) const
            {
                return zone_id == other.zone_id && destination_zone_id == other.destination_zone_id
                       && caller_zone_id == other.caller_zone_id;
            }
        };

        struct orig_zone_hash
        {
            std::size_t operator()(orig_zone const& s) const noexcept
            {
                std::size_t h1 = std::hash<uint64_t>{}(s.zone_id.get_val());
                std::size_t h2 = std::hash<uint64_t>{}(s.destination_zone_id.get_val());
                std::size_t h3 = std::hash<uint64_t>{}(s.caller_zone_id.get_val());
                return h1 ^ (h2 << 1) ^ (h3 << 2); // or use boost::hash_combine
            }
        };

        struct interface_proxy_id
        {
            bool operator==(const interface_proxy_id& other) const
            {
                return zone_id == other.zone_id && destination_zone_id == other.destination_zone_id
                       && object_id == other.object_id && interface_id == other.interface_id;
            }
            rpc::zone zone_id = {0};
            rpc::destination_zone destination_zone_id = {0};
            rpc::object object_id = {0};
            rpc::interface_ordinal interface_id = {0};
        };

        struct interface_proxy_id_hash
        {
            std::size_t operator()(interface_proxy_id const& s) const noexcept
            {
                std::size_t h1 = std::hash<uint64_t>{}(s.zone_id.get_val());
                std::size_t h2 = std::hash<uint64_t>{}(s.destination_zone_id.get_val());
                std::size_t h3 = std::hash<uint64_t>{}(s.object_id.get_val());
                return h1 ^ (h2 << 1) ^ (h3 << 2); // or use boost::hash_combine
            }
        };

        struct impl
        {
            rpc::zone zone_id;
            std::string name;
            uint_fast64_t count;
        };

        struct stub_info
        {
            uint64_t address = 0;
            uint64_t count = 0;
        };

        mutable std::mutex mux;
        mutable std::unordered_map<rpc::zone, name_count> services;
        mutable std::unordered_map<orig_zone, name_count, orig_zone_hash> service_proxies;
        mutable std::unordered_map<uint64_t, rpc::zone> historical_impls;
        mutable std::unordered_map<uint64_t, impl> impls;
        mutable std::unordered_map<zone_object, stub_info, zone_object_hash> stubs;
        mutable std::unordered_map<interface_proxy_id, name_count, interface_proxy_id_hash> interface_proxies;
        mutable std::unordered_map<interface_proxy_id, uint64_t, interface_proxy_id_hash> object_proxies;

        FILE* output_ = nullptr;

        sequence_diagram_telemetry_service(FILE* output);

        void add_new_object(const std::string& name, uint64_t address, rpc::zone zone_id) const;

    public:
        static bool create(std::shared_ptr<rpc::i_telemetry_service>& service,
            const std::string& test_suite_name,
            const std::string& name,
            const std::filesystem::path& directory);

        virtual ~sequence_diagram_telemetry_service();

        void on_service_creation(
            const std::string& name, rpc::zone zone_id, rpc::destination_zone parent_zone_id) const override;
        void on_service_deletion(rpc::zone zone_id) const override;
        void on_service_try_cast(rpc::zone zone_id,
            rpc::destination_zone destination_zone_id,
            rpc::caller_zone caller_zone_id,
            rpc::object object_id,
            rpc::interface_ordinal interface_id) const override;
        void on_service_add_ref(rpc::zone zone_id,
            rpc::destination_zone destination_zone_id,
            rpc::object object_id,
            rpc::caller_zone caller_zone_id,
            rpc::known_direction_zone known_direction_zone_id,
            rpc::add_ref_options options,
            uint64_t reference_count) const override;
        void on_service_release(rpc::zone zone_id,
            rpc::destination_zone destination_zone_id,
            rpc::object object_id,
            rpc::caller_zone caller_zone_id,
            rpc::release_options options,
            uint64_t reference_count) const override;

        void on_service_proxy_creation(const std::string& service_name,
            const std::string& service_proxy_name,
            rpc::zone zone_id,
            rpc::destination_zone destination_zone_id,
            rpc::caller_zone caller_zone_id) const override;
        void on_cloned_service_proxy_creation(const std::string& service_name,
            const std::string& service_proxy_name,
            rpc::zone zone_id,
            rpc::destination_zone destination_zone_id,
            rpc::caller_zone caller_zone_id) const override;
        void on_service_proxy_deletion(
            rpc::zone zone_id, rpc::destination_zone destination_zone_id, rpc::caller_zone caller_zone_id) const override;
        void on_service_proxy_try_cast(rpc::zone zone_id,
            rpc::destination_zone destination_zone_id,
            rpc::caller_zone caller_zone_id,
            rpc::object object_id,
            rpc::interface_ordinal interface_id) const override;
        void on_service_proxy_add_ref(rpc::zone zone_id,
            rpc::destination_zone destination_zone_id,
            rpc::caller_zone caller_zone_id,
            rpc::object object_id,
            rpc::known_direction_zone known_direction_zone_id,
            rpc::add_ref_options options,
            uint64_t reference_count) const override;
        void on_service_proxy_release(rpc::zone zone_id,
            rpc::destination_zone destination_zone_id,
            rpc::caller_zone caller_zone_id,
            rpc::object object_id,
            rpc::release_options options,
            uint64_t reference_count) const override;
        void on_service_proxy_add_external_ref(rpc::zone zone_id,
            rpc::destination_zone destination_zone_id,
            rpc::caller_zone caller_zone_id,
            int ref_count) const override;
        void on_service_proxy_release_external_ref(rpc::zone zone_id,
            rpc::destination_zone destination_zone_id,
            rpc::caller_zone caller_zone_id,
            int ref_count) const override;

        void on_impl_creation(const std::string& name, uint64_t address, rpc::zone zone_id) const override;
        void on_impl_deletion(uint64_t address, rpc::zone zone_id) const override;

        void on_stub_creation(rpc::zone zone_id, rpc::object object_id, uint64_t address) const override;
        void on_stub_deletion(rpc::zone zone_id, rpc::object object_id) const override;
        void on_stub_send(rpc::zone zone_id,
            rpc::object object_id,
            rpc::interface_ordinal interface_id,
            rpc::method method_id) const override;
        void on_stub_add_ref(rpc::zone zone_id,
            rpc::object object_id,
            rpc::interface_ordinal interface_id,
            uint64_t count,
            rpc::caller_zone caller_zone_id) const override;
        void on_stub_release(rpc::zone zone_id,
            rpc::object object_id,
            rpc::interface_ordinal interface_id,
            uint64_t count,
            rpc::caller_zone caller_zone_id) const override;

        void on_object_proxy_creation(rpc::zone zone_id,
            rpc::destination_zone destination_zone_id,
            rpc::object object_id,
            bool add_ref_done) const override;
        void on_object_proxy_deletion(
            rpc::zone zone_id, rpc::destination_zone destination_zone_id, rpc::object object_id) const override;

        void on_interface_proxy_creation(const std::string& name,
            rpc::zone zone_id,
            rpc::destination_zone destination_zone_id,
            rpc::object object_id,
            rpc::interface_ordinal interface_id) const override;
        void on_interface_proxy_deletion(rpc::zone zone_id,
            rpc::destination_zone destination_zone_id,
            rpc::object object_id,
            rpc::interface_ordinal interface_id) const override;
        void on_interface_proxy_send(const std::string& method_name,
            rpc::zone zone_id,
            rpc::destination_zone destination_zone_id,
            rpc::object object_id,
            rpc::interface_ordinal interface_id,
            rpc::method method_id) const override;

        void message(level_enum level, const std::string& message) const override;

        // Transport events
        void on_transport_creation(const std::string& name,
            rpc::zone zone_id,
            rpc::zone adjacent_zone_id,
            rpc::transport_status status) const override;
        void on_transport_deletion(rpc::zone zone_id, rpc::zone adjacent_zone_id) const override;
        void on_transport_status_change(const std::string& name,
            rpc::zone zone_id,
            rpc::zone adjacent_zone_id,
            rpc::transport_status old_status,
            rpc::transport_status new_status) const override;
        void on_transport_add_destination(rpc::zone zone_id,
            rpc::zone adjacent_zone_id,
            rpc::destination_zone destination,
            rpc::caller_zone caller) const override;
        void on_transport_remove_destination(rpc::zone zone_id,
            rpc::zone adjacent_zone_id,
            rpc::destination_zone destination,
            rpc::caller_zone caller) const override;

        // Pass-through events
        void on_pass_through_creation(rpc::zone zone_id,
            rpc::destination_zone forward_destination,
            rpc::destination_zone reverse_destination,
            uint64_t shared_count,
            uint64_t optimistic_count) const override;
        void on_pass_through_deletion(rpc::zone zone_id,
            rpc::destination_zone forward_destination,
            rpc::destination_zone reverse_destination) const override;
        void on_pass_through_add_ref(rpc::zone zone_id,
            rpc::destination_zone forward_destination,
            rpc::destination_zone reverse_destination,
            rpc::add_ref_options options,
            int64_t shared_delta,
            int64_t optimistic_delta) const override;
        void on_pass_through_release(rpc::zone zone_id,
            rpc::destination_zone forward_destination,
            rpc::destination_zone reverse_destination,
            int64_t shared_delta,
            int64_t optimistic_delta) const override;
        void on_pass_through_status_change(rpc::zone zone_id,
            rpc::destination_zone forward_destination,
            rpc::destination_zone reverse_destination,
            rpc::transport_status forward_status,
            rpc::transport_status reverse_status) const override;

        // Service methods (from i_marshaller interface)
        void on_service_send(zone zone_id,
            destination_zone destination_zone_id,
            caller_zone caller_zone_id,
            object object_id,
            interface_ordinal interface_id,
            method method_id) const override;
        void on_service_post(zone zone_id,
            destination_zone destination_zone_id,
            caller_zone caller_zone_id,
            object object_id,
            interface_ordinal interface_id,
            method method_id) const override;
        void on_service_object_released(
            zone zone_id, destination_zone destination_zone_id, caller_zone caller_zone_id, object object_id) const override;
        void on_service_transport_down(
            zone zone_id, destination_zone destination_zone_id, caller_zone caller_zone_id) const override;

        // Service proxy methods (from i_marshaller interface)
        void on_service_proxy_send(zone zone_id,
            destination_zone destination_zone_id,
            caller_zone caller_zone_id,
            object object_id,
            interface_ordinal interface_id,
            method method_id) const override;
        void on_service_proxy_post(zone zone_id,
            destination_zone destination_zone_id,
            caller_zone caller_zone_id,
            object object_id,
            interface_ordinal interface_id,
            method method_id) const override;
        void on_service_proxy_object_released(
            zone zone_id, destination_zone destination_zone_id, caller_zone caller_zone_id, object object_id) const override;
        void on_service_proxy_transport_down(
            zone zone_id, destination_zone destination_zone_id, caller_zone caller_zone_id) const override;

        // Transport outbound methods
        void on_transport_outbound_send(zone zone_id,
            zone adjacent_zone_id,
            destination_zone destination_zone_id,
            caller_zone caller_zone_id,
            object object_id,
            interface_ordinal interface_id,
            method method_id) const override;
        void on_transport_outbound_post(zone zone_id,
            zone adjacent_zone_id,
            destination_zone destination_zone_id,
            caller_zone caller_zone_id,
            object object_id,
            interface_ordinal interface_id,
            method method_id) const override;
        void on_transport_outbound_try_cast(zone zone_id,
            zone adjacent_zone_id,
            destination_zone destination_zone_id,
            caller_zone caller_zone_id,
            object object_id,
            interface_ordinal interface_id) const override;
        void on_transport_outbound_add_ref(zone zone_id,
            zone adjacent_zone_id,
            destination_zone destination_zone_id,
            caller_zone caller_zone_id,
            object object_id,
            known_direction_zone known_direction_zone_id,
            add_ref_options options,
            uint64_t reference_count) const override;
        void on_transport_outbound_release(zone zone_id,
            zone adjacent_zone_id,
            destination_zone destination_zone_id,
            caller_zone caller_zone_id,
            object object_id,
            release_options options,
            uint64_t reference_count) const override;
        void on_transport_outbound_object_released(zone zone_id,
            zone adjacent_zone_id,
            destination_zone destination_zone_id,
            caller_zone caller_zone_id,
            object object_id) const override;
        void on_transport_outbound_transport_down(zone zone_id,
            zone adjacent_zone_id,
            destination_zone destination_zone_id,
            caller_zone caller_zone_id) const override;

        // Transport inbound methods
        void on_transport_inbound_send(zone zone_id,
            zone adjacent_zone_id,
            destination_zone destination_zone_id,
            caller_zone caller_zone_id,
            object object_id,
            interface_ordinal interface_id,
            method method_id) const override;
        void on_transport_inbound_post(zone zone_id,
            zone adjacent_zone_id,
            destination_zone destination_zone_id,
            caller_zone caller_zone_id,
            object object_id,
            interface_ordinal interface_id,
            method method_id) const override;
        void on_transport_inbound_try_cast(zone zone_id,
            zone adjacent_zone_id,
            destination_zone destination_zone_id,
            caller_zone caller_zone_id,
            object object_id,
            interface_ordinal interface_id) const override;
        void on_transport_inbound_add_ref(zone zone_id,
            zone adjacent_zone_id,
            destination_zone destination_zone_id,
            caller_zone caller_zone_id,
            object object_id,
            known_direction_zone known_direction_zone_id,
            add_ref_options options,
            uint64_t reference_count) const override;
        void on_transport_inbound_release(zone zone_id,
            zone adjacent_zone_id,
            destination_zone destination_zone_id,
            caller_zone caller_zone_id,
            object object_id,
            release_options options,
            uint64_t reference_count) const override;
        void on_transport_inbound_object_released(zone zone_id,
            zone adjacent_zone_id,
            destination_zone destination_zone_id,
            caller_zone caller_zone_id,
            object object_id) const override;
        void on_transport_inbound_transport_down(zone zone_id,
            zone adjacent_zone_id,
            destination_zone destination_zone_id,
            caller_zone caller_zone_id) const override;
    };
}
